<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Urban Lunch</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --hint-color: #8e8e93;
            --button-color: #f2f2f7;
            --accent-color: #ff3b30;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            padding-bottom: 100px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        header {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            z-index: 100;
            padding: 15px;
            border-bottom: 1px solid #efefef;
        }
        .header-title {
            font-size: 22px;
            font-weight: 800;
            text-align: center;
            letter-spacing: -0.5px;
        }
        .categories {
            display: flex;
            overflow-x: auto;
            padding: 10px 0;
            gap: 20px;
            scrollbar-width: none;
        }
        .categories::-webkit-scrollbar { display: none; }
        .category-item {
            font-size: 14px;
            font-weight: 600;
            color: var(--hint-color);
            white-space: nowrap;
            cursor: pointer;
            transition: 0.2s;
        }
        .category-item.active {
            color: var(--text-color);
            border-bottom: 2px solid var(--text-color);
        }
        .products-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 15px;
        }
        .product-card {
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.4s ease;
        }
        .product-image {
            width: 100%;
            aspect-ratio: 1 / 1;
            background-color: #f9f9f9;
            border-radius: 20px;
            object-fit: cover;
            margin-bottom: 8px;
        }
        .product-name {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 6px;
            height: 36px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .product-price-btn {
            background-color: var(--button-color);
            border: none;
            border-radius: 12px;
            padding: 10px 12px;
            font-size: 14px;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .product-price-btn span { color: var(--accent-color); }

        /* Модальное окно выбора */
        #modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        #product-modal {
            position: fixed;
            bottom: -100%;
            left: 0; right: 0;
            background: white;
            border-radius: 30px 30px 0 0;
            padding: 25px;
            z-index: 1001;
            transition: bottom 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
            max-height: 80vh;
            overflow-y: auto;
        }
        #product-modal.open { bottom: 0; }
        .modal-label { font-size: 12px; font-weight: 700; color: #999; text-transform: uppercase; margin: 15px 0 10px; }
        .option-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .option-item {
            background: var(--button-color);
            padding: 10px 15px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            border: 2px solid transparent;
        }
        .option-item.active { border-color: #000; background: #fff; }
        .add-to-cart-btn {
            width: 100%;
            background: #000;
            color: #fff;
            border: none;
            padding: 18px;
            border-radius: 18px;
            font-size: 16px;
            font-weight: 700;
            margin-top: 25px;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <div class="header-title" id="adm-trg">URBAN LUNCH</div>
    <div class="categories" id="cat-list"></div>
</header>

<div class="products-grid" id="main-grid"></div>

<div id="modal-overlay" onclick="closeModal()"></div>
<div id="product-modal">
    <div id="modal-body"></div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const urlParams = new URLSearchParams(window.location.search);
let hiddenIds = JSON.parse(urlParams.get('stops') || '[]');

const menu = [
    { cat: "КОФЕ", items: [
        { id: 1, name: "КАПУЧИНО", prices: {"250МЛ": 190, "350МЛ": 230, "450МЛ": 270}, milk: true, syrup: true },
        { id: 2, name: "ЛАТТЕ", prices: {"250МЛ": 190, "350МЛ": 230, "450МЛ": 270}, milk: true, syrup: true },
        { id: 3, name: "ЭСПРЕССО", prices: {"30МЛ": 110, "60МЛ": 150} },
        { id: 4, name: "АМЕРИКАНО", prices: {"250МЛ": 180, "350МЛ": 220, "450МЛ": 260}, syrup: true },
        { id: 5, name: "ФЛАТ УАЙТ", prices: {"250МЛ": 220, "350МЛ": 260, "450МЛ": 360}, milk: true },
        { id: 6, name: "РАФ", prices: {"250МЛ": 210, "350МЛ": 250, "450МЛ": 290}, milk: true, syrup: true },
        { id: 7, name: "БАМБЛ ТЕПЛЫЙ", prices: {"350МЛ": 270, "450МЛ": 300} }
    ]},
    { cat: "ЧАЙ", items: [
        { id: 10, name: "ЧАЙ ЧЕРНЫЙ", prices: {"250МЛ": 120, "350МЛ": 150, "450МЛ": 180} },
        { id: 11, name: "ЧАЙ ЗЕЛЕНЫЙ", prices: {"250МЛ": 120, "350МЛ": 150, "450МЛ": 180} },
        { id: 12, name: "ЧАЙ КАРКАДЕ", prices: {"250МЛ": 120, "350МЛ": 150, "450МЛ": 180} },
        { id: 13, name: "ЧАЙ ЗЕЛЕНЫЙ ЖАСМИН", prices: {"250МЛ": 120, "350МЛ": 150, "450МЛ": 180} },
        { id: 14, name: "ЧАЙ ТРАВЯНОЙ", prices: {"250МЛ": 120, "350МЛ": 150, "450МЛ": 180} },
        { id: 15, name: "МАТЧА", prices: {"250МЛ": 180, "350МЛ": 220, "450МЛ": 260}, milk: true, syrup: true },
        { id: 16, name: "КАКАО", prices: {"250МЛ": 180, "350МЛ": 220, "450МЛ": 260}, milk: true },
        { id: 17, name: "ПРЯНЫЙ ЧАЙ", prices: {"250МЛ": 240, "350МЛ": 280, "450МЛ": 320} },
        { id: 18, name: "ГОРЯЧИЙ ШОКОЛАД", prices: {"250МЛ": 240, "350МЛ": 280, "450МЛ": 320} }
    ]},
    { cat: "ПУНШИ", items: [
        { id: 20, name: "ГЛИНТВЕЙН", prices: {"350МЛ": 230, "450МЛ": 270} },
        { id: 21, name: "ОБЛЕПИХОВЫЙ ПУНШ", prices: {"350МЛ": 230, "450МЛ": 270} },
        { id: 22, name: "МАЛИНОВЫЙ ПУНШ", prices: {"350МЛ": 230, "450МЛ": 270} }
    ]},
    { cat: "ХОЛОДНЫЕ", items: [
        { id: 30, name: "АЙС ЛАТТЕ", prices: {"250МЛ": 240, "350МЛ": 280}, milk: true, syrup: true },
        { id: 31, name: "ЭСПРЕССО ТОНИК ГРАНАТ", prices: {"350МЛ": 250, "450МЛ": 290} },
        { id: 32, name: "ЭСПРЕССО ТОНИК ОБЫЧНЫЙ", prices: {"350МЛ": 250, "450МЛ": 290} },
        { id: 33, name: "БАМБЛ ХОЛОДНЫЙ", prices: {"350МЛ": 270, "450МЛ": 300} },
        { id: 34, name: "АЙС МАТЧА", prices: {"350МЛ": 230, "450МЛ": 270}, milk: true },
        { id: 35, name: "ЛИМОНАД КИВИ-ФЕЙХОА", prices: {"350МЛ": 260, "450МЛ": 290} },
        { id: 36, name: "ЛИМОНАД МАНГО-МАРАКУЙА", prices: {"350МЛ": 260, "450МЛ": 290} },
        { id: 37, name: "ЛИМОНАД СМОРОДИНА-МЯТА", prices: {"350МЛ": 260, "450МЛ": 290} }
    ]},
    { cat: "СЕЗОННЫЕ", items: [
        { id: 40, name: "ЛАТТЕ ХАЛВА", prices: {"350МЛ": 290, "450МЛ": 350}, milk: true },
        { id: 41, name: "ЛАТТЕ ТЫКВА", prices: {"350МЛ": 290, "450МЛ": 350}, milk: true },
        { id: 42, name: "РАФ СНИКЕРС", prices: {"350МЛ": 320, "450МЛ": 380} },
        { id: 43, name: "ЛАТТЕ ORANGE CHRISTMAS", prices: {"350МЛ": 320, "450МЛ": 380} }
    ]},
    { cat: "СЛАДОСТИ", items: [
        { id: 50, name: "Bombbar лесной орех", prices: {"1ШТ": 130} },
        { id: 51, name: "Bombbar малиновый", prices: {"1ШТ": 130} },
        { id: 52, name: "Bombbar кокос", prices: {"1ШТ": 130} },
        { id: 53, name: "Snaqer лесной орех", prices: {"1ШТ": 130} },
        { id: 54, name: "Chika смородина", prices: {"1ШТ": 170} },
        { id: 55, name: "Chika банан", prices: {"1ШТ": 170} }
    ]},
    { cat: "ГАЗИРОВКА", items: [
        { id: 60, name: "Cola Черноголовка", prices: {"0.5Л": 140} },
        { id: 61, name: "Байкал Черноголовка", prices: {"0.5Л": 140} },
        { id: 62, name: "Вода Газ/Негаз", prices: {"0.5Л": 70} },
        { id: 63, name: "Лимонад Черноголовка", prices: {"0.5Л": 140} }
    ]}
];

let cart = [];
const milkOpts = {"Обычное": 0, "Банановое": 70, "Кокосовое": 70, "Миндальное": 70, "Безлактозное": 70};
const syrupOpts = ["Нет", "Ваниль", "Карамель", "Лесной орех", "Фисташка", "Кокос"];

function init() {
    const cl = document.getElementById('cat-list');
    cl.innerHTML = menu.map((c, i) => `<div class="category-item ${i===0?'active':''}" onclick="filter('${c.cat}', this)">${c.cat}</div>`).join('');
    render('КОФЕ');
}

function render(categoryName) {
    const grid = document.getElementById('main-grid');
    grid.innerHTML = '';
    const category = menu.find(c => c.cat === categoryName);
    category.items.forEach(item => {
        if (hiddenIds.includes(item.id)) return;
        const card = document.createElement('div');
        card.className = 'product-card';
        card.onclick = () => openItem(item.id);
        card.innerHTML = `
            <img class="product-image" src="item.jpg">
            <div class="product-name">${item.name}</div>
            <div class="product-price-btn">${Object.values(item.prices)[0]} ₽ <span>+</span></div>
        `;
        grid.appendChild(card);
    });
}

function openItem(id) {
    let itm; menu.forEach(c => c.items.forEach(i => { if(i.id === id) itm = i; }));
    window.selection = { itm, size: Object.keys(itm.prices)[0], milk: "Обычное", syrup: "Нет" };
    showModal();
}

function showModal() {
    const s = window.selection;
    const body = document.getElementById('modal-body');
    body.innerHTML = `
        <h2 style="margin:0; font-size: 24px;">${s.itm.name}</h2>
        <div class="modal-label">Размер</div>
        <div class="option-list">${Object.keys(s.itm.prices).map(z => `<div class="option-item ${z===s.size?'active':''}" onclick="selection.size='${z}';showModal()">${z}</div>`).join('')}</div>
        ${s.itm.milk ? `<div class="modal-label">Молоко (+70₽)</div><div class="option-list">${Object.keys(milkOpts).map(m => `<div class="option-item ${m===s.milk?'active':''}" onclick="selection.milk='${m}';showModal()">${m}</div>`).join('')}</div>` : ''}
        ${s.itm.syrup ? `<div class="modal-label">Сироп (+30₽)</div><div class="option-list">${syrupOpts.map(y => `<div class="option-item ${y===s.syrup?'active':''}" onclick="selection.syrup='${y}';showModal()">${y}</div>`).join('')}</div>` : ''}
        <button class="add-to-cart-btn" onclick="add()">В корзину — ${calc()} ₽</button>
    `;
    document.getElementById('modal-overlay').style.display = 'block';
    document.getElementById('product-modal').classList.add('open');
}

function calc() {
    let p = selection.itm.prices[selection.size];
    if (selection.milk !== "Обычное") p += 70;
    if (selection.syrup !== "Нет") p += 30;
    return p;
}

function add() {
    cart.push({...selection, finalPrice: calc()});
    tg.MainButton.setText(`ОФОРМИТЬ ЗАКАЗ: ${cart.reduce((a,b)=>a+b.finalPrice,0)} ₽`).show();
    closeModal();
}

function filter(name, el) {
    document.querySelectorAll('.category-item').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
    render(name);
}

function closeModal() {
    document.getElementById('product-modal').classList.remove('open');
    document.getElementById('modal-overlay').style.display = 'none';
}

tg.onEvent('mainButtonClicked', () => {
    const data = { prices: cart.map(i => ({ label: `${i.itm.name} ${i.size}`, amount: i.finalPrice * 100 })) };
    tg.sendData(JSON.stringify(data));
});

// Админ-функция (скрытие товаров)
let t;
document.getElementById('adm-trg').ontouchstart = () => t = setTimeout(() => {
    if(prompt('Password') === '7654') {
        let list = prompt('ID товаров через запятую для скрытия (например: 1,2,3)');
        tg.sendData(JSON.stringify({action: 'hide_bulk', ids: list.split(',').map(Number)}));
        tg.close();
    }
}, 3000);
document.getElementById('adm-trg').ontouchend = () => clearTimeout(t);

init();
</script>
</body>
</html>
