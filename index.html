<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // 1. ВАЖНО: Берем стоп-лист из параметров ссылки, которую прислал бот
    const urlParams = new URLSearchParams(window.location.search);
    const stopParam = urlParams.get('stop');
    let stopList = stopParam ? stopParam.split(',').map(Number) : [];

    let isAdmin = false;
    let cart = [];
    const menu = [
        { id: 1, name: "Капучино", price: 190 },
        { id: 2, name: "Латте", price: 190 },
        { id: 3, name: "Американо", price: 150 },
        { id: 4, name: "Чай Черный", price: 120 }
    ];

    // Долгое нажатие для админа (7654)
    let pressTimer;
    document.getElementById('main-header').addEventListener('touchstart', () => {
        pressTimer = window.setTimeout(() => {
            if (prompt("Пароль:") === "7654") {
                isAdmin = true;
                document.getElementById('admin-panel').style.display = 'block';
                render();
            }
        }, 1500);
    });
    document.getElementById('main-header').addEventListener('touchend', () => clearTimeout(pressTimer));

    function render() {
        const app = document.getElementById('app');
        // Показываем только то, чего нет в стоп-листе (если не админ)
        const visibleMenu = isAdmin ? menu : menu.filter(item => !stopList.includes(item.id));
        
        app.innerHTML = visibleMenu.map(item => {
            const isHidden = stopList.includes(item.id);
            return `
                <div class="card ${isAdmin && isHidden ? 'selected-to-hide' : ''}" 
                     onclick="${isAdmin ? `toggleAdminSelection(${item.id})` : `addToCart(${item.id})`}">
                    <div class="img-placeholder"></div>
                    <div style="font-weight:600">${item.name}</div>
                    <div>${item.price} ₽</div>
                    ${isAdmin ? `<div style="color:red; font-size:10px; font-weight:bold">${isHidden ? 'СКРЫТО' : 'ВИДИМО'}</div>` : ''}
                </div>
            `;
        }).join('');
    }

    function toggleAdminSelection(id) {
        if (stopList.includes(id)) {
            stopList = stopList.filter(item => item !== id);
        } else {
            stopList.push(id);
        }
        render();
    }

    function saveAdminChanges() {
        // Отправляем новый стоп-лист боту
        tg.sendData(JSON.stringify({ type: 'admin_update', stop_list: stopList }));
        isAdmin = false;
        document.getElementById('admin-panel').style.display = 'none';
        tg.close(); // Закрываем Mini App
    }

    function addToCart(id) {
        const product = menu.find(i => i.id === id);
        cart.push(product);
        tg.MainButton.setText(`КОРЗИНА: ${cart.reduce((s,i)=>s+i.price,0)} ₽`).show();
    }

    tg.MainButton.onClick(() => {
        document.getElementById('cart-list').innerHTML = cart.map(i => `
            <div style="display:flex; justify-content:space-between; padding:5px 0;"><span>${i.name}</span><b>${i.price} ₽</b></div>
        `).join('');
        document.getElementById('total').innerText = cart.reduce((a,b)=>a+b.price,0) + ' ₽';
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('cart-view').classList.add('open');
    });

    function sendOrder() {
        const f = document.getElementById('floor').value;
        const o = document.getElementById('office').value;
        if(!f || !o) return alert("Укажите этаж и офис!");
        tg.sendData(JSON.stringify({
            type: 'order',
            items: cart.map(i => ({ label: i.name, amount: i.price * 100 })),
            address: `Этаж: ${f}, Офис: ${o}`
        }));
    }

    render();
</script>
